<h2 id="post-title">Tiêu đề bài viết</h2>
<p><strong>Người đăng:</strong> <span id="post-author">Đang tải...</span></p>
<p id="post-content"></p>

<!-- Hiển thị hình ảnh -->
<div id="post-images"></div>

<!-- Khu vực nhập bình luận -->
<h3>Bình luận</h3>
<textarea id="comment-input" placeholder="Nhập bình luận..."></textarea>
<button id="submit-comment">Gửi</button>

<!-- Danh sách bình luận -->
<div id="comments-container"></div>

<script>
    async function fetchPostDetails() {
        const urlParams = new URLSearchParams(window.location.search);
        const postid = urlParams.get("id"); // Lấy ID từ URL
        if (!postid) {
            console.error("Không tìm thấy ID bài viết.");
            return;
        }

        try {
            // Lấy dữ liệu bài viết
            const postResponse = await fetch(`/api/posts/${postid}`);
            if (!postResponse.ok) throw new Error("Lỗi khi tải bài viết");
            const post = await postResponse.json();

            document.getElementById("post-title").innerText = post.title;
            document.getElementById("post-content").innerText = post.content;

            // Lấy tên người đăng
            const userResponse = await fetch(`/getUser/${post.userid}`);
            if (userResponse.ok) {
                const userData = await userResponse.json();
                document.getElementById("post-author").innerText = userData.username || "Ẩn danh";
            }

            // Hiển thị ảnh
            const imageContainer = document.getElementById("post-images");
            post.images.forEach(image => {
                const img = document.createElement("img");
                img.src = image;
                img.style = "width:100%; border-radius:10px; margin-top:10px;";
                imageContainer.appendChild(img);
            });

            // Lấy bình luận
            fetchComments(postid);
        } catch (error) {
            console.error("Lỗi khi tải chi tiết bài viết:", error);
        }
    }

    async function fetchComments(postid) {
        try {
            const response = await fetch(`/api/comments/${postid}`);
            if (!response.ok) throw new Error("Lỗi khi tải bình luận");
            const comments = await response.json();

            const commentContainer = document.getElementById("comments-container");
            commentContainer.innerHTML = ""; // Xóa bình luận cũ

            comments.forEach(comment => {
                const commentElement = document.createElement("div");
                commentElement.className = "comment";
                commentElement.innerHTML = `
                    <p><strong>${comment.username}:</strong> ${comment.content}</p>
                `;
                commentContainer.appendChild(commentElement);
            });
        } catch (error) {
            console.error("Lỗi khi tải bình luận:", error);
        }
    }

    async function submitComment() {
        const urlParams = new URLSearchParams(window.location.search);
        const postid = urlParams.get("id");
        const content = document.getElementById("comment-input").value.trim();

        if (!content) {
            alert("Vui lòng nhập bình luận.");
            return;
        }

        try {
            const response = await fetch(`/api/comments`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ postid, content }),
            });

            if (!response.ok) throw new Error("Lỗi khi gửi bình luận");

            document.getElementById("comment-input").value = ""; // Xóa nội dung nhập vào
            fetchComments(postid); // Tải lại bình luận
        } catch (error) {
            console.error("Lỗi khi gửi bình luận:", error);
        }
    }

    document.getElementById("submit-comment").addEventListener("click", submitComment);

    fetchPostDetails();
</script>
